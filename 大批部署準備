# ğŸš€ è™›æ“¬æ©ŸåŸºç¤è¨­æ–½éƒ¨ç½²èˆ‡ç®¡ç†æŒ‡å— (NFS + SSH è‡ªå‹•åŒ–)

æœ¬æ–‡ä»¶æ•´ç†äº†å¾ VM ç¯„æœ¬ (Template) æº–å‚™åˆ° NFS å…±äº«é…ç½®ï¼Œä»¥åŠä½¿ç”¨ SSH é‡‘é‘°å¯¦ç¾æ‰¹é‡è‡ªå‹•åŒ–ç®¡ç†çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ¯ éšæ®µä¸€ï¼šåŸºç¤ VM ç¯„æœ¬é€šç”¨åŒ– (Template Generalization)

åœ¨ ESXi ç’°å¢ƒä¸­è£½ä½œç¯„æœ¬å‰ï¼Œç§»é™¤ VM ç¨ç‰¹çš„è­˜åˆ¥ç¬¦æ˜¯é˜²æ­¢ç¶²è·¯å’Œ SSH è¡çªçš„é—œéµã€‚

### 1. æœå‹™å®‰è£èˆ‡ç³»çµ±å„ªåŒ–

| ä¸»é¡Œ | èªªæ˜ | åŸ·è¡ŒæŒ‡ä»¤ |
| :--- | :--- | :--- |
| **é è£æ ¸å¿ƒå·¥å…·** | å®‰è£ SSH ä¼ºæœå™¨å’Œ NFS å…±äº«æ‰€éœ€çš„æ‰€æœ‰å·¥å…·ã€‚ | `sudo apt update`<br>`sudo apt install -y openssh-server nfs-common nfs-kernel-server` |
| **æ—¥èªŒå¤§å°é™åˆ¶** | é˜²æ­¢ç³»çµ±æ—¥èªŒç„¡é™å¢é•·ä½”ç”¨ç¡¬ç¢Ÿç©ºé–“ã€‚ | **ç·¨è¼¯:** `sudo nano /etc/systemd/journald.conf` <br>**è¨­å®š:** `SystemMaxUse=500M` |

### 2. æ¸…ç†å”¯ä¸€è­˜åˆ¥ç¬¦ (Template Clean Up)

```bash
# A. ç§»é™¤ SSH Host Keys (æœ€é—œéµï¼é˜²æ­¢è¤‡è£½å¾Œçš„ SSH è¡çª)
sudo rm -f /etc/ssh/ssh_host_*

# B. æ¸…ç†ç¶²è·¯ç¶å®šè¨˜éŒ„
sudo rm -f /etc/udev/rules.d/70-persistent-net.rules

# C. æ¸…ç†å¿«å–èˆ‡æ­·å²è¨˜éŒ„
sudo apt clean
history -c && rm -f ~/.bash_history


-------------------------------------------------------------------------------------------


éšæ®µäºŒï¼šNFS å…±äº«æœå‹™é…ç½® (ä¼ºæœå™¨ç«¯: 192.168.8.40)

å°‡å…¶ä¸­ä¸€å° VM é…ç½®ç‚º NFS ä¼ºæœå™¨ï¼Œä¸¦è¨­å®šå…±äº«è·¯å¾‘ç‚º /home/ubn/Sharedã€‚

1. æº–å‚™å…±äº«ç›®éŒ„èˆ‡æ¬Šé™
Bash

# å‰µå»ºå…±äº«ç›®éŒ„ä¸¦ç¢ºä¿ ubn æ“æœ‰æ¬Šé™
sudo mkdir -p /home/ubn/Shared
sudo chown ubn:ubn /home/ubn/Shared

# æ”¾ç½®è¦å…±äº«çš„æª”æ¡ˆ
mv /home/ubn/run.sh /home/ubn/Shared/

2. åŒ¯å‡ºé…ç½®èˆ‡å•Ÿç”¨æœå‹™
Bash

# ç·¨è¼¯ NFS åŒ¯å‡ºé…ç½®æª”æ¡ˆ
sudo nano /etc/exports

# è²¼ä¸ŠåŒ¯å‡ºè¦å‰‡ (å…è¨± 192.168.8.x ç¶²æ®µè®€å¯«)
/home/ubn/Shared 192.168.8.0/24(rw,sync,no_subtree_check)

# é‡æ–°è¼‰å…¥é…ç½®ä¸¦é‡å•Ÿæœå‹™
sudo exportfs -ra
sudo systemctl restart nfs-server

-------------------------------------------------------------------------------------------

ğŸ”‘ éšæ®µä¸‰ï¼šSSH è‡ªå‹•åŒ–èˆ‡å®¢æˆ¶ç«¯æ‰¹é‡ç®¡ç†

é€™æ˜¯å¯¦ç¾ç„¡å¯†ç¢¼ç®¡ç†å’Œè‡ªå‹•åŒ–é…ç½®çš„æµç¨‹ã€‚
1. SSH é‡‘é‘°è¨­ç½® (å¯¦ç¾ç„¡å¯†ç¢¼é€£ç·š)

åŸ·è¡Œä½ç½®ï¼š åœ¨æ‚¨ç”¨æ–¼ç®¡ç†çš„é›»è…¦ (MobaXterm Local Terminal æˆ– ç®¡ç†æ©Ÿ) ä¸ŠåŸ·è¡Œã€‚
Bash

# A. ç”Ÿæˆé‡‘é‘° (ä½¿ç”¨é è¨­å€¼å³å¯)
ssh-keygen -t rsa -b 4096

# B. éƒ¨ç½²å…¬é‘°åˆ°æ‰€æœ‰ç›®æ¨™ VM (å®¢æˆ¶ç«¯å’Œå…±äº«ä¼ºæœå™¨)
# *æ­¤ç‚ºæœ€å¾Œä¸€æ¬¡éœ€è¦è¼¸å…¥å¯†ç¢¼*
ssh-copy-id ubn@<ç›®æ¨™VMçš„IPåœ°å€>

2. å®¢æˆ¶ç«¯é…ç½®æ‰¹é‡æ›´æ–°è…³æœ¬

ä½¿ç”¨æ­¤è…³æœ¬å¯ä¸€éµä¿®æ­£å®¢æˆ¶ç«¯ VM /etc/fstab ä¸­çš„èˆŠ IP åœ°å€å’Œè·¯å¾‘ã€‚
Bash

# è«‹å°‡æ­¤å…§å®¹å„²å­˜ç‚º update_fstab.sh æª”æ¡ˆï¼Œä¸¦çµ¦äºˆåŸ·è¡Œæ¬Šé™: chmod +x update_fstab.sh
#!/bin/bash

# --- å›ºå®šé…ç½®è®Šæ•¸ (è«‹å‹¿ä¿®æ”¹ï¼Œé™¤éè·¯å¾‘æœ‰è®Š) ---
USER="ubn"
OLD_PATH="/home/ubn/share"   # å®¢æˆ¶ç«¯ fstab ä¸­ç¾æœ‰çš„èˆŠè·¯å¾‘éƒ¨åˆ†
NEW_PATH="/home/ubn/Shared"  # å…±äº«ä¼ºæœå™¨ä¸Šæ­£ç¢ºçš„æ–°è·¯å¾‘éƒ¨åˆ†
MOUNT_POINT="/mnt/getshare"
SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

# --- äº’å‹•è¼¸å…¥ ---
echo "--- å®¢æˆ¶ç«¯ NFS é…ç½®è‡ªå‹•æ›´æ–°å·¥å…· ---"
read -p "1. è«‹è¼¸å…¥è¦ä¿®æ”¹çš„å®¢æˆ¶ç«¯ VM IP: " CLIENT_IP
read -p "2. è«‹è¼¸å…¥å®¢æˆ¶ç«¯ fstab ä¸­ç¾æœ‰çš„ã€èˆŠå…±äº« IPã€‘: " OLD_SHARE_IP
read -p "3. è«‹è¼¸å…¥æ–°çš„å…±äº« VM IP: " NEW_SHARE_IP

# æ§‹å»ºæ›¿æ›å­—ä¸²
OLD_CONFIG="${OLD_SHARE_IP}:${OLD_PATH}"
NEW_CONFIG="${NEW_SHARE_IP}:${NEW_PATH}"

echo "--- æ­£åœ¨é€£ç·šä¸¦è‡ªå‹•æ›´æ–° ${CLIENT_IP} ---"

# --- é ç«¯ SSH å‘½ä»¤åŸ·è¡Œ (åˆ©ç”¨é‡‘é‘°å¯¦ç¾ç„¡å¯†ç¢¼æ“ä½œ) ---
ssh ${USER}@${CLIENT_IP} ${SSH_OPTIONS} "
  echo '1. æ­£åœ¨æ›¿æ› fstab ä¸­çš„ NFS å…±äº«é…ç½®...'
  sudo sed -i 's|${OLD_CONFIG}|${NEW_CONFIG}|g' /etc/fstab;

  echo '2. æ­£åœ¨å˜—è©¦å¸è¼‰èˆŠçš„æ›è¼‰é» ${MOUNT_POINT}...'
  sudo umount -l ${MOUNT_POINT};

  echo '3. æ­£åœ¨æ‡‰ç”¨æ–°çš„ fstab é…ç½®ä¸¦é‡æ–°æ›è¼‰...'
  sudo mount -a;
  
  echo '4. é©—è­‰æ–°çš„æ›è¼‰ç‹€æ…‹...'
  mount | grep getshare;
"

echo "--- å®¢æˆ¶ç«¯ ${CLIENT_IP} é…ç½®æ›´æ–°å®Œæˆ ---"
